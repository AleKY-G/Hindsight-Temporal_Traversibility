# Hindsight is 20/20: Leveraging Past Traversals to Aid 3D Perception

This is official code release for paper **Hindsight is 20/20: Leveraging Past Traversals to Aid 3D Perception**.

## Environment

## Data Pre-processing
### Lyft Dataset
#### Download and conver to KITTI format
Download the Lyft Level 5 AV Dataset from https://level5.lyft.com/dataset/ and decompress it
into `LYFT_ROOT`. Install Lyft Dataset SDK (https://github.com/lyft/nuscenes-devkit).

We have been experimenting with an earlier version of lyft dataset, which contains
fewer sequences than the lastest version.
We dumped the sample tokens of the old version into
`data_preprocessing/lyft/lyft_2019_train_sample_tokens.txt`.

Convert the lyft dataset into KITTI format to `LYFT_KITTI_FORMAT` by
```bash
ln -s LYFT_ROOT/train/train_maps LYFT_ROOT/train/maps
ln -s LYFT_ROOT/train/train_lidars LYFT_ROOT/train/lidars
ln -s LYFT_ROOT/train/train_images LYFT_ROOT/train/images
cd data_processing/lyft
python lyft2kitti.py --store_dir LYFT_KITTI_FORMAT --lyft_dataroot LYFT_ROOT/train --table_folder LYFT_ROOT/train/train_data --sample_token_list ./lyft_2019_train_sample_tokens.txt --meta_info_prefix trainset_
```

The indices of traversals are dumped in `data_preprocessing/lyft/meta_data/lyft_2019_train_sample_tracks.pkl`.

#### Obtain the train/test split
*You can skip the following by directly using the uploaded files in
`data_preprocessing/lyft/meta_data/`.*

The train/test split of the traversals by their geo-location
is generated by the following commands.
```bash
cd data_processing/lyft
python split_traintest.py --data_root LYFT_KITTI_FORMAT --track_list_file meta_data/lyft_2019_train_sample_tracks.pkl
```
It will generate
```
data_preprocessing/lyft/meta_data/train_track_list.pkl
data_preprocessing/lyft/meta_data/valid_train_idx_info.pkl
data_preprocessing/lyft/meta_data/train_idx.txt # 12407 samples

data_preprocessing/lyft/meta_data/test_track_list.pkl
data_preprocessing/lyft/meta_data/valid_test_idx_info.pkl
data_preprocessing/lyft/meta_data/test_idx.txt # 2917 samples
```
**Note that the `test_idx.txt` is not used, please use `data_preprocessing/lyft/meta_data/time_valid_test_idx.txt` (2274 samples, subset of `test_idx.txt`) as the test set to reproduce the results.**
`time_valid_test_idx.txt` contains
sample ids that have traversals predates the collection time. We use this test set
in the early development and report the evaluation results on this test set.
We observe a similar trend on `data_preprocessing/lyft/meta_data/test_idx.txt`.

#### Gather the historical traversals

```bash
cd data_processing/lyft
python gather_historical_traversals.py --track_path meta_data/train_track_list.pkl --idx_info meta_data/valid_train_idx_info.pkl --idx_list meta_data/train_idx.txt --data_root LYFT_KITTI_FORMAT --traversal_ptc_save_root LYFT_KITTI_FORMAT/training/combined_lidar --trans_mat_save_root LYFT_KITTI_FORMAT/training/trans_mat

python gather_historical_traversals.py --track_path meta_data/test_track_list.pkl --idx_info meta_data/valid_test_idx_info.pkl --idx_list meta_data/time_valid_test_idx.txt --data_root LYFT_KITTI_FORMAT --traversal_ptc_save_root LYFT_KITTI_FORMAT/training/combined_lidar --trans_mat_save_root LYFT_KITTI_FORMAT/training/trans_mat
```
Traversals

### nuScenes Dataset

## Training and Evaluation

## License